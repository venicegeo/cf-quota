#!groovy

node {
  def root = pwd()
  stage("Setup") {
    deleteDir()
    if(env.GITLAB_CREDS) {
      git url: "${env.GIT_URL}", branch: "${env.GIT_BRANCH}", credentialsId: "${env.GITLAB_CREDS}"
    } else {
      git url: "${env.GIT_URL}", branch: "${env.GIT_BRANCH}"
    }
  }

  stage("debug" {
    sh "pwd"
    sh "ls -al"
  }
  stage("Get quotas") {
    withEnv(["CF_HOME=.cf"]) {
      withCredentials([
        [$class: 'UsernamePasswordMultiBinding', credentialsId: "${env.L2-PCF_Creds}", usernameVariable: "CFUSER", passwordVariable: "CFPASS"]
      ]) {
        sh "cf api ${env.PCF_API_ENDPOINT}"
        sh "cf auth ${CFUSER} ${CFPASS}"
        sh "python cf-quota/cf-quota.py"
        sh "cf logout"
      }
    }
  }
}
