#!groovy

node {
def root = pwd()
stage("Setup") {
  deleteDir()
  if(env.GITLAB_CREDS) {
    git url: "${env.GIT_URL}", branch: "${env.GIT_BRANCH}", credentialsId: "${env.GITLAB_CREDS}"
  } else {
    git url: "${env.GIT_URL}", branch: "${env.GIT_BRANCH}"
  }
}

stage("Get quotas") {
  withEnv(["CF_HOME=.cf"]) {
    withCredentials([
      [$class: 'UsernamePasswordMultiBinding', credentialsId: "${env.PCF_CREDS}", usernameVariable: "CFUSER", passwordVariable: "CFPASS"]
    ]) {
      sh "cf api ${env.PCF_API_ENDPOINT}"
      sh "cf auth ${CFUSER} ${CFPASS}"
      sh "cf target -o ${env.PCF_ORG} -s ${env.PHASE_ONE_PCF_SPACE}"
      sh "python cf-quota/cf-quota.py"
    }
}
